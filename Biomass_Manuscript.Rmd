---
title: "Biomass_Manuscript"
author: "Dustin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup-libraries, include=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(multcomp)
library(multcompView)
library(colorspace)
library(scales)
library(patchwork)
library(PLS205)
```


## **1. Load and Clean Data**
```{r load-data, message=FALSE, warning=FALSE}
biomass_data <- read.csv("biomass_data_manuscript.csv") %>%
mutate(
burn = factor(burn, levels = c("h", "ln", "lo", "n")),
sterilization = factor(sterilization),
drought = factor(drought, levels = c("full_water", "ABA", "primed")),
plant_id = factor(plant_id),
rack = factor(rack)
)
```


## **2. Model Selection: Mixed vs Fixed Effects**
```{r model-comparison}

# Test model with rack as a random effect
biomass_model_lmer <- lmer(dry_biomass ~ burn * sterilization * drought + (1 | rack), data = biomass_data)
biomass_model_lm <- lm(dry_biomass ~ burn * sterilization * drought, data = biomass_data)
anova(biomass_model_lmer, biomass_model_lm)
```


**We found that rack explained no significant variation in biomass (Chisq = 0, p = 1.000), so we used a fixed-effects model for final analyses.**


## **3. Final Model and Summary**
```{r final-model}

# Full linear model without rack
biomass_model <- lm(dry_biomass ~ burn * sterilization * drought, data = biomass_data)
summary(biomass_model)


```
```{r diagnostics, echo=TRUE, eval=TRUE, include=FALSE}
# Check model assumptions
pls205_diagnostics(biomass_model)
```



## **4. ANOVA, Estimated Marginal Means and Group Comparisons**
```{r emmeans-results}
# ANOVA for full factorial model
anova(biomass_model)

# Get means estimates for burn severity
burn_means <- emmeans(biomass_model, ~ burn)
burn_means

# Contrast means
burn_contrast <- contrast(burn_means, method = "trt.vs.ctrl", ref = "h")
burn_contrast

# Full factorial EMMs
effects_emm <- emmeans(biomass_model, ~ burn * sterilization * drought)
# CLD grouping
effects_cld <- cld(effects_emm, adjust = "bonferroni", Letters = letters)

# Print the results
print(effects_emm)
print(effects_cld)

# For unsterilized only
biomass_unsterilized <- biomass_data %>% filter(sterilization == "unsterilized")
unsterilized_model <- lm(dry_biomass ~ burn, data = biomass_unsterilized)
unsterilized_emm <- emmeans(unsterilized_model, ~ burn)
unsterilized_cld <- cld(unsterilized_emm, adjust = "bonferroni", Letters = letters)

# Print the results
print(unsterilized_emm)
print(unsterilized_cld)

```


## **5. Figure: Unsterilized Soils**
```{r unsterilized-plot}

# Colorblind-friendly palette 
burn_colors_cb <- c(
  "High" = hcl(15, 75, 55),
  "Low (Initial)" = hcl(260, 60, 65),
  "Low (Advanced)" = hcl(75, 65, 75),
  "Suppressed" = hcl(330, 50, 70)
)

# CLD
unsterilized_cld$burn <- recode(unsterilized_cld$burn, 
                                h = "High", ln = "Low (Initial)", lo = "Low (Advanced)", n = "Suppressed")
unsterilized_cld$label_y <- max(biomass_data$dry_biomass, na.rm = TRUE) + 0.05

# Determine shared y-axis range
y_limits <- c(0, max(biomass_data$dry_biomass, na.rm = TRUE) + 0.05)

# Plot unsterilized soil biomass
final_burn_plot <- biomass_unsterilized %>%
  mutate(burn = recode(burn, 
                       h = "High", ln = "Low (Initial)", lo = "Low (Advanced)", n = "Suppressed")) %>%
  ggplot(aes(x = burn, y = dry_biomass, fill = burn)) +
  geom_boxplot(width = 0.6, outlier.shape = NA, alpha = 0.8, color = "black") +
  geom_jitter(width = 0.15, size = 1.5, shape = 21, color = "black", stroke = 0.3, alpha = 0.6) +
  geom_text(data = unsterilized_cld, aes(x = burn, y = label_y, label = .group),
            inherit.aes = FALSE, fontface = "bold", size = 5) +
  scale_fill_manual(values = burn_colors_cb) +
  coord_cartesian(ylim = y_limits) +
  labs(x = "Burn Severity", y = "Dry Biomass (g)", title = "Unsterilized Soils") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 50, hjust = 1, face = "bold"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.position = "none"
  )

final_burn_plot
```

## 6. Figure: Sterilized Soils
```{r sterilized-plot}

# Filter for sterilized soils only
biomass_sterilized <- biomass_data %>% filter(sterilization == "sterilized")

model_sterilized <- lm(dry_biomass ~ burn, data = biomass_sterilized)
burn_emm_sterilized <- emmeans(model_sterilized, ~ burn)
burn_cld_sterilized <- cld(burn_emm_sterilized, adjust = "bonferroni", Letters = letters)

burn_cld_sterilized$burn <- recode(burn_cld_sterilized$burn, 
                                   h = "High", ln = "Low (Initial)", lo = "Low (Advanced)", n = "Suppressed")
burn_cld_sterilized$label_y <- max(biomass_data$dry_biomass, na.rm = TRUE) + 0.05

# Plot biomass for sterilized soils
plot_sterilized <- biomass_sterilized %>%
  mutate(burn = recode(burn, 
                       h = "High", ln = "Low (Initial)", lo = "Low (Advanced)", n = "Suppressed")) %>%
  ggplot(aes(x = burn, y = dry_biomass, fill = burn)) +
  geom_boxplot(width = 0.6, outlier.shape = NA, alpha = 0.8, color = "black") +
  geom_jitter(width = 0.15, size = 1.5, shape = 21, color = "black", stroke = 0.3, alpha = 0.6) +
  geom_text(data = burn_cld_sterilized, aes(x = burn, y = label_y, label = .group),
            inherit.aes = FALSE, fontface = "bold", size = 5) +
  scale_fill_manual(values = burn_colors_cb) +
  coord_cartesian(ylim = y_limits) +
  labs(x = "Burn Severity", y = "Dry Biomass (g)", title = "Sterilized Soils") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 50, hjust = 1, face = "bold"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.position = "none"
  )

plot_sterilized
```


## 7. Combined Figure
```{r combined-plot, fig.width=12, fig.height=7}
# Figure 1: Biomass
combined_biomass_plot <- final_burn_plot + plot_sterilized +
  plot_layout(nrow = 1, guides = "collect")

combined_biomass_plot
```





