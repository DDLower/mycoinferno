---
title: "Colonization_manuscript"
author: "Dustin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## **1. Load Required Libraries**
```{r setup-libraries, include=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(lme4)
library(lmerTest)
library(emmeans)
library(multcompView)
library(multcomp)
library(colorspace)
library(performance)
library(patchwork)
library(PLS205)
library(forcats)
```


## **2. Load and Prepare Data**
```{r load-data, message=FALSE, warning=FALSE}
colonization_data <- read.csv("colonization_data.csv") %>%
mutate(
plant_id = factor(plant_id),
burn = factor(burn, levels = c("h", "ln", "lo", "n")),
drought = factor(drought),
sterilization = factor(sterilization),
rack = factor(rack)
)
str(colonization_data)
```


## **3. Evaluate Rack as Random Effect**
```{r test-random-effect}

# Test model with rack as a random effect
col_model_rack <- lmer(perc_col ~ burn * drought * sterilization + (1 | rack), data = colonization_data)

# Full linear model without rack
col_model <- lm(perc_col ~ burn * drought * sterilization, data = colonization_data)
anova(col_model_rack, col_model)
```
**We found that rack explained no significant variation in biomass (Chisq = 0, p = 1.000), so we used a fixed-effects model for final analyses.**

## **3. Filter for Unsterilized Samples and Fit Final Model**
```{r fit-final-model}
# Filter to unsterilized samples only and re-do levels
colonization_filtered <- colonization_data %>%
  filter(sterilization == "u") %>%
  mutate(
    burn = fct_recode(burn,
      "High"          = "h",
      "Low (Initial)" = "ln",
      "Low (Advanced)"= "lo",
      "Suppressed"    = "n"
    ),
    # Set desired factor order (reference level = "High")
    burn = fct_relevel(burn, "High", "Low (Initial)", "Low (Advanced)", "Suppressed")
  )

# Apply arcsine sqrt transformation
colonization_transformed <- colonization_filtered %>%
  mutate(perc_col_asin = asin(sqrt(perc_col / 100)))

```


```{r diagnostics, echo=TRUE, eval=TRUE, include=FALSE}

# Final full model for diagnostics (after filtering to unsterilized samples)
col_model_trans <- lm(perc_col_asin ~ burn * drought, data = colonization_transformed)

# Check model assumptions
pls205_diagnostics(col_model_trans)
```


## **4. ANOVA and Estimated Marginal Means**
```{r anova-emmeans}
# ANOVA
anova(col_model_trans)

# Drought and burn x drought interaction not significant
# Simplify model for CLD table
col_model_simple <- lm(perc_col_asin ~ burn, data = colonization_transformed)

# Get estimated marginal means
em <- emmeans(col_model_simple, ~ burn)

# Get pairwise comparisons
pairwise <- contrast(em, method = "pairwise", adjust = "none")

# Get the summary and clean the names
pw_summary <- summary(pairwise)

# Keep only one direction of each contrast
pvals_named <- pw_summary$p.value
names(pvals_named) <- gsub(" - ", "-", pw_summary$contrast)
pvals_named <- pvals_named[!duplicated(names(pvals_named))]   

# Create compact letters
letter_obj <- multcompLetters(pvals_named, threshold = 0.05)

# Print the resulting letters to verify
letter_obj$Letters

# Merge with EMMs safely
cld_tbl <- as.data.frame(em) %>%
  mutate(
    .group = letter_obj$Letters[match(as.character(burn), names(letter_obj$Letters))],
    perc_bt = (sin(emmean))^2 * 100
  )

cld_tbl

# Get Dunnett comparisons
dunnett_contrasts <- contrast(em, method = "dunnett", ref = "High")
summary(dunnett_contrasts)

```

```{r}
# Back-transform arcsine sqrt: 
# high
asin_mean <- 0.635
prop_est <- (sin(asin_mean)^2)
prop_est

# low (initial)
asin_mean2 <- 0.812
prop_est2 <- (sin(asin_mean2)^2)
prop_est2

# low (advanced)
asin_mean3 <- 0.804
prop_est3 <- (sin(asin_mean3)^2)
prop_est3

# suppressed
asin_mean4 <- 0.692
prop_est4 <- (sin(asin_mean4)^2)
prop_est4
```


## **5. Final Plot: Percent Colonization**
```{r final-plot, fig.width=10, fig.height=6}

# Define colorblind-safe fill colors
burn_colors_cb <- c(
  "High"       = hcl(h = 15,  c = 75, l = 55),
  "Low (Initial)"  = hcl(h = 260, c = 60, l = 65),
  "Low (Advanced)"  = hcl(h = 75,  c = 65, l = 75),
  "Suppressed"      = hcl(h = 330, c = 50, l = 70)
)

# Set a uniform height for CLD letters across all groups
cld_tbl$label_y <- 75  # Set this to a constant height that clears all whiskers
y_axis_limit <- 80     # Set y-axis max just above the labels

# Final colonization plot
final_colonization_plot <- ggplot(
  colonization_filtered %>% mutate(perc_col = perc_col * 100),
  aes(x = burn, y = perc_col, fill = burn)
) +
  geom_boxplot(
    outlier.shape = NA,
    alpha = 0.9,
    width = 0.6,
    color = "black",
    linewidth = 0.8
  ) +
  geom_jitter(
    size = 2.5,
    width = 0.15,
    alpha = 0.7,
    shape = 21,
    stroke = 0.6,
    color = "black"
  ) +
  geom_text(
    data = cld_tbl,
    aes(x = burn, y = label_y, label = .group),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  scale_fill_manual(values = burn_colors_cb) +
  scale_y_continuous(
    name = "Percent Colonization (%)",
    limits = c(0, y_axis_limit),
    expand = expansion(mult = c(0, 0))
  ) +
  labs(x = "Burn Severity") +
  theme_minimal(base_size = 14) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.position = "none"
  )

# Display the final aligned figure
final_colonization_plot

```












