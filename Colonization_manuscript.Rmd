---
title: "Colonization_manuscript"
author: "Dustin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## **1. Load Required Libraries**
```{r setup-libraries, include=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(lme4)
library(lmerTest)
library(emmeans)
library(multcompView)
library(colorspace)
library(performance)
library(patchwork)
```


## **2. Load and Prepare Data**
```{r load-data, message=FALSE, warning=FALSE}
colonization_data <- read.csv("colonization_data.csv") %>%
mutate(
plant_id = factor(plant_id),
burn = factor(burn, levels = c("h", "ln", "lo", "n")),
drought = factor(drought),
sterilization = factor(sterilization),
rack = factor(rack)
)
str(colonization_data)
```


## **3. Evaluate Rack as Random Effect**
```{r test-random-effect}

# Test model with rack as a random effect
col_model_rack <- lmer(perc_col ~ burn * drought * sterilization + (1 | rack), data = colonization_data)

# Full linear model without rack
col_model <- lm(perc_col ~ burn * drought * sterilization, data = colonization_data)
anova(col_model_rack, col_model)
```
**We found that rack explained no significant variation in biomass (Chisq = 0, p = 1.000), so we used a fixed-effects model for final analyses.**

## **3. Filter for Unsterilized Samples and Fit Final Model**
```{r fit-final-model}
# Filter to unsterilized samples only and re-do levels
colonization_filtered <- colonization_data %>%
  filter(sterilization == "u") %>%
  mutate(
    burn = recode(burn,
      h  = "High",
      ln = "Low (New)",
      lo = "Low (Old)",
      n  = "Never"
    ),
    burn = factor(burn, levels = c("High", "Low (New)", "Low (Old)", "Never"))
  )

# Create transformed column only for modeling
colonization_transformed <- colonization_filtered %>%
  mutate(perc_col_asin = asin(sqrt(perc_col / 100)))  # divide by 100 to convert % to proportion

# Linear model with transformed response
col_model_trans <- lm(perc_col_asin ~ burn * drought, data = colonization_transformed)

```


```{r diagnostics, echo=TRUE, eval=TRUE, include=FALSE}
# Check model assumptions
pls205_diagnostics(col_model_trans)
```


## **4. ANOVA and Estimated Marginal Means**
```{r anova-emmeans}
anova(col_model_trans)

# Run Dunnett-adjusted pairwise comparisons (using High as reference)
col_dunnett <- emmeans(col_model_trans, specs = "burn") %>%
  contrast(method = "trt.vs.ctrl", ref = 1, adjust = "dunnett")  # 1 = "High"

# View the pairwise comparisons
summary(col_dunnett)

# Get estimated marginal means for back-transformation and plotting
col_means_trans <- emmeans(col_model_trans, ~ burn)

# Generate CLD based on Dunnett's test (manually supply contrasts)
cld_tbl <- cld(
  col_means_trans,
  adjust = "dunnett",
  Letters = letters,
  sort = FALSE
) %>%
  as.data.frame() %>%
  mutate(
    perc_bt = (sin(emmean))^2 * 100  # back-transform to percent
  )

cld_tbl

```
```{r}
# Back-transform arcsine sqrt: 
# high
asin_mean <- 0.635
prop_est <- (sin(asin_mean)^2)
prop_est

# ln
asin_mean2 <- 0.812
prop_est2 <- (sin(asin_mean2)^2)
prop_est2

# lo
asin_mean3 <- 0.804
prop_est3 <- (sin(asin_mean3)^2)
prop_est3

# n
asin_mean4 <- 0.692
prop_est4 <- (sin(asin_mean4)^2)
prop_est4
```


## **5. Final Plot: Percent Colonization**
```{r final-plot}
# Calculate CLD label height
cld_y <- max(colonization_filtered$perc_col * 100, na.rm = TRUE)
cld_pad <- max(2, 0.03 * diff(range(colonization_filtered$perc_col * 100, na.rm = TRUE)))
cld_y <- cld_y + cld_pad
cld_tbl$label_y <- cld_y

# Define colorblind-safe fill colors
burn_colors_cb <- c(
  "High"       = hcl(h = 15,  c = 75, l = 55),
  "Low (New)"  = hcl(h = 260, c = 60, l = 65),
  "Low (Old)"  = hcl(h = 75,  c = 65, l = 75),
  "Never"      = hcl(h = 330, c = 50, l = 70)
)

# Final plot with restored styling
## Figure 2: Colonzation
final_colonization_plot <- ggplot(
  colonization_filtered %>% mutate(perc_col = perc_col * 100),
  aes(x = burn, y = perc_col, fill = burn)
) +
  geom_boxplot(
    outlier.shape = NA,
    alpha = 0.9,
    width = 0.6,
    color = "black",    
    linewidth = 0.8
  ) +
  geom_jitter(
    size = 2.5,
    width = 0.15,
    alpha = 0.7,
    shape = 21,          
    stroke = 0.6,        
    color = "black"     
  ) +
  geom_text(
    data = cld_tbl,
    aes(x = burn, y = label_y, label = .group),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  scale_fill_manual(values = burn_colors_cb) +
  scale_y_continuous(
    name = "Percent colonization (%)",
    limits = c(0, cld_y + cld_pad),
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(x = "Burn severity") +
  theme_minimal(base_size = 14) +
  theme(
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.position = "none"
  )

# Figure 2: Colonization
final_colonization_plot
```









