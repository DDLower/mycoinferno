---
title: "NMDS"
author: "Dustin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




## **1. Load Data and Create Phyloseq Object**

```{r libraries, include=FALSE}
library(phyloseq)
library(ggplot2)
library(patchwork)
library(vegan)
library(ggtext)
```


```{r load-data,message=FALSE, warning=FALSE}

# Set seed for reproducibility
set.seed(42)

# Load CSV files
otu_table <- read.csv("otu_table_mycoinferno.csv", row.names = 1)
taxonomy_table <- read.csv("tax_table_mycoinferno.csv", row.names = 1)
metadata <- read.csv("metadata.csv", row.names = 1)

# Clean factor levels
metadata$burn_severity <- factor(
  metadata$burn_severity,
  levels = c("High", "Low_New", "Low_Old", "Never"),
  labels = c("High", "Low (Initial)", "Low (Advanced)", "Suppressed")
)

table(metadata$burn_severity, useNA = "ifany")

# Convert to phyloseq components
OTU <- otu_table(as.matrix(otu_table), taxa_are_rows = TRUE)
TAX <- tax_table(as.matrix(taxonomy_table))
META <- sample_data(metadata)

# Create phyloseq object
physeq <- phyloseq(OTU, TAX, META)
```


## **2. Filter and Transform**
```{r filter and transform}
# Filter out problematic seedlings for all-taxa NMDS
problematic_samples_full <- c("Seedling248", "Seedling243")
physeq_filtered_full <- prune_samples(!sample_names(physeq) %in% problematic_samples_full, physeq)
physeq_all_transformed <- transform_sample_counts(physeq_filtered_full, function(x) x / sum(x))

# Filter for EMF dataset
problematic_samples_emf <- c("Seedling248", "Seedling243", "Seedling269")
physeq_filtered_emf <- prune_samples(!sample_names(physeq) %in% problematic_samples_emf, physeq)

non_emf_taxa <- c(
  "Exophiala_equina", "Phialocephacla_fortinii", "Phialocephala_sp", "Phialocephala_helvetica", 
  "Phialomyces_arenicola", "Entoloma_sclerotiogenum", "Paraphoma_fimeti", "Ilyonectria_sp", 
  "Ilyonectria_destructans", "Belonioscyphella_sp", "Fusarium_sp", 
  "Leohumicola_minima", "Myxomphalia_maura"
)

non_emf_asvs <- taxa_names(physeq_filtered_emf)[
  grepl(paste(non_emf_taxa, collapse = "|"), tax_table(physeq_filtered_emf)[, "species"])
]

physeq_emf <- prune_taxa(!taxa_names(physeq_filtered_emf) %in% non_emf_asvs, physeq_filtered_emf)
physeq_emf <- prune_samples(sample_sums(physeq_emf) > 0, physeq_emf)

physeq_emf_transformed <- transform_sample_counts(physeq_emf, function(x) {
  if (sum(x) == 0) rep(0, length(x)) else x / sum(x)
})
```

## **3. Ordinate and Plot**
```{r ordinate and plot, fig.width=12, fig.height=6}

# Run NMDS ordinations
nmds_all <- ordinate(physeq_all_transformed, method = "NMDS", distance = "bray")
nmds_emf <- ordinate(physeq_emf_transformed, method = "NMDS", distance = "bray")

# Convert ordination output to data frames with metadata merged in
ordination_df_all <- as.data.frame(scores(nmds_all, display = "sites"))
ordination_df_all$sample <- rownames(ordination_df_all)
ordination_df_all <- merge(ordination_df_all, as.data.frame(sample_data(physeq_all_transformed)), by.x = "sample", by.y = "row.names")

ordination_df_emf <- as.data.frame(scores(nmds_emf, display = "sites"))
ordination_df_emf$sample <- rownames(ordination_df_emf)
ordination_df_emf <- merge(ordination_df_emf, as.data.frame(sample_data(physeq_emf_transformed)), by.x = "sample", by.y = "row.names")


# Colors
burn_colors_cb <- c(
  "High"       = hcl(15,  75, 55),
  "Low (Initial)"  = hcl(260, 60, 65),
  "Low (Advanced)"  = hcl(75,  65, 75),
  "Suppressed"      = hcl(330, 50, 70)
)

lims_x <- c(-4, 6)
lims_y <- c(-3.5, 2)
annotation_x <- 1.0
annotation_y <- -1.6

# Flip coordinates ONCE so both match direction

ordination_df_emf$NMDS1 <- -ordination_df_emf$NMDS1
ordination_df_all$NMDS2 <- -ordination_df_all$NMDS2


# Flip NMDS1 for horizontal alignment
ordination_df_all$NMDS1 <- -ordination_df_all$NMDS1
ordination_df_emf$NMDS1 <- -ordination_df_emf$NMDS1

# Fix factor levels
ordination_df_all$burn_severity <- factor(trimws(ordination_df_all$burn_severity),
  levels = c("High", "Low (Initial)", "Low (Advanced)", "Suppressed"))
ordination_df_emf$burn_severity <- factor(trimws(ordination_df_emf$burn_severity),
  levels = c("High", "Low (Initial)", "Low (Advanced)", "Suppressed"))

# Convert "Drought" â†’ "Water Limitation", preserve all valid entries
ordination_df_all$water <- factor(
  recode(trimws(ordination_df_all$water),
         "Drought" = "Water Limitation",
         "Normal" = "Normal"),
  levels = c("Water Limitation", "Normal")
)

ordination_df_emf$water <- factor(
  recode(trimws(ordination_df_emf$water),
         "Drought" = "Water Limitation",
         "Normal" = "Normal"),
  levels = c("Water Limitation", "Normal")
)


# PLOT A: All Taxa
p_all <- ggplot(ordination_df_all, aes(NMDS1, NMDS2, color = burn_severity, shape = water)) +
  geom_point(size = 3) +
  scale_color_manual(name = "Burn Severity", values = burn_colors_cb) +
  scale_shape_manual(name = "Water Treatment", values = c("Normal" = 17, "Water Limitation" = 16), drop = FALSE) +
  coord_cartesian(xlim = lims_x, ylim = lims_y, expand = FALSE) +
  annotate("richtext", x = 0.5, y = -3, hjust = 0, size = 2.8, fill = NA, label.color = NA,
           label = paste0(
             "<b>PERMANOVA</b><br>",
             "Burn severity: <i>R</i><sup>2</sup> = 0.171, <i>p</i> = 0.001***<br>",
             "Water: <i>R</i><sup>2</sup> = 0.017, <i>p</i> = 0.665<br>",
             "Dispersion: <i>p</i> = 0.18<br>",
             "<i>Stress</i> = 0.075"
           )) +
  labs(title = "All Taxa", x = "NMDS1", y = "NMDS2") +
  theme_minimal(base_size = 14) +
  theme(
    axis.title   = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.margin  = margin(t = 10, r = 10, b = 10, l = 10),
    legend.position = "none"
  )

# PLOT B: EMF Only
p_emf <- ggplot(ordination_df_emf, aes(NMDS1, NMDS2, color = burn_severity, shape = water)) +
  geom_point(size = 3) +
  scale_color_manual(name = "Burn Severity", values = burn_colors_cb) +
  scale_shape_manual(name = "Water Treatment", values = c("Normal" = 17, "Water Limitation" = 16), drop = FALSE) +
  coord_cartesian(xlim = lims_x, ylim = lims_y, expand = FALSE) +
  annotate("richtext", x = 0.5, y = -3, hjust = 0, size = 2.8, fill = NA, label.color = NA,
           label = paste0(
             "<b>PERMANOVA</b><br>",
             "Burn severity: <i>R</i><sup>2</sup> = 0.171, <i>p</i> = 0.001***<br>",
             "Water: <i>R</i><sup>2</sup> = 0.016, <i>p</i> = 0.695<br>",
             "Dispersion: <i>p</i> = 0.30<br>",
             "<i>Stress</i> = 0.084"
           )) +
  labs(title = "EMF Taxa", x = "NMDS1", y = "NMDS2") +
  theme_minimal(base_size = 14) +
  theme(
    axis.title   = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.margin  = margin(t = 10, r = 10, b = 10, l = 10),
    legend.position = "right"
  )

p_emf
# COMBINE
## Figure 5: NMDS
final_nmds_plot <- (p_all + p_emf) +
  plot_layout(ncol = 2, widths = c(1, 1), guides = "collect") +
  plot_annotation(
    tag_levels = "A",
    theme = theme_minimal(base_size = 14) + theme(
      plot.tag = element_text(face = "bold", size = 16),
      plot.tag.position = c(0, 1),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
  )

# Figure 5
final_nmds_plot


```


# **4. PERMANOVA for All Taxa**

```{r permanova all}
# Make Bray-Curtis distance matrix
bray_dist <- phyloseq::distance(physeq_all_transformed, method = "bray")

# Extract sample data
metadata <- as(sample_data(physeq_all_transformed), "data.frame")

# Check sample order
all(rownames(metadata) == labels(bray_dist))  # should return TRUE

# Now run PERMANOVA
adonis2(bray_dist ~ burn_severity * water, data = metadata)

# Burn severity alone
adonis2(bray_dist ~ burn_severity, data = metadata, permutations = 999)

# Water alone
adonis2(bray_dist ~ water, data = metadata, permutations = 999)


```

```{r betadisper all}
# Test for homogeneity of group dispersions
bd_burn <- betadisper(bray_dist, metadata$burn_severity)

# View ANOVA on dispersions
anova(bd_burn)
```

# **5. PERMANOVA for EMF Taxa**
```{r permanova emf}
# Calculate Bray-Curtis distance matrix
emf_bray <- phyloseq::distance(physeq_emf_transformed, method = "bray")

# Extract metadata (sample data to use as model input
emf_metadata <- as(sample_data(physeq_emf_transformed), "data.frame")

# Run PERMANOVA on EMF community
adonis2(emf_bray ~ burn_severity * water, data = emf_metadata)

# Burn severity only
adonis2(emf_bray ~ burn_severity, data = emf_metadata, permutations = 999)

# Water only
adonis2(emf_bray ~ water, data = emf_metadata, permutations = 999)

```

```{r betadisper emf}

# Test for homogeneity of group dispersions for EMF
emf_beta_disp <- betadisper(emf_bray, group = emf_metadata$burn_severity)


# ANOVA on dispersions
anova(emf_beta_disp)

```


